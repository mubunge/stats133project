---
title: "what"
author: "batman"
date: ""
output: html_document
---
<!-- leave this material as is -->
Compiled on `r base::date()`.

```{r include = FALSE}
library(DataComputing)
library(printr)
library(feather)
```
<!-- put your content after this line -->
*Source file* 
```{r, results='asis', echo=FALSE}
includeSourceDocuments()
```

<!-- Don't edit the material above this line -->
get data from tab delimited files and csvs
```{r, eval = T}
# store a list of files
files <- dir("star_results/", recursive = T)
excludeFiles <- grepl("entities|Entities", files, perl = T)
files <- files[!excludeFiles]
files <- lapply(files, function(x) {paste("star_results/", x, sep = "")})

## now get the stuff we want
for (f in files) {
    if (grepl("csv|CSV", f)) {
        cur <- read.csv(f)
    } else {
        # 1998
        if (f == "star_results/1998/tdstar.tab") {
            cur <- read.table(f, sep = "\t", header = T)
            cur <- cur %>%
                select(-c(County_Code, School_Code,
                          County_Name, School_Name,
                          District_Name, Grade_Level,
                          Total_Enrolled, Total_Tested,
                          Reading_Total_Valid, Math_Total_Valid,
                          Language_Total_Valid, Spelling_Total_Valid,
                          Science_Total_Valid, Social_Science_Total_Valid,
                          Filler))

            cur[, -1] <- cur[, -1] %>%
                sapply(as.numeric)

            cur <- cur %>%
                group_by(District_Code, Record_Type, Summary_Type) %>%
                summarise_each(funs(mean(., na.rm = T)))
        } 
        # 1999
        else if (f == "star_results/1999/tdtestdata.tab") {
            cur <- read.table(f, sep = "\t")
            cur <- cur %>%
                select(-c(1, 3, 7:9, 10, 16, 22, 28, 34, 40, 46:77))

            # Column names are not listed in the file, so we'll set them here
            colnames(cur) <- c("District_Code",
                               "Test_Date",
                               "Record_Type",
                               "Summary_Type",
                               "Reading_Mean_SS",
                               "Reading_Mean_PR",
                               "Reading_PAC75",
                               "Reading_PACAT50",
                               "Reading_PAC25",
                               "Math_Mean_SS",
                               "Math_Mean_PR",
                               "Math_PAC75",
                               "Math_PACAT50",
                               "Math_PAC25",
                               "Language_Mean_SS",
                               "Language_Mean_PR",
                               "Language_PAC75",
                               "Language_PACAT50",
                               "Language_PAC25",
                               "Spelling_Mean_SS",
                               "Spelling_Mean_PR",
                               "Spelling_PAC75",
                               "Spelling_PACAT50",
                               "Spelling_PAC25",
                               "Science_Mean_SS",
                               "Science_Mean_PR",
                               "Science_PAC75",
                               "Science_PACAT50",
                               "Science_PAC25",
                               "Social_Science_Mean_SS",
                               "Social_Science_Mean_PR",
                               "Social_Science_PAC75",
                               "Social_Science_PACAT50",
                               "Social_Science_PAC25"
                               )

            cur[, -1] <- cur[, -1] %>%
                sapply(as.numeric)

            cur <- cur %>%
                group_by(District_Code, Record_Type, Summary_Type) %>%
                summarise_each(funs(mean(., na.rm = T)))
        }
    }

    # serialize to binary file
    year_matches <- stringr::str_match(f, "star_results/(\\d{4})/.*")
    year <- year_matches[[2]]
    binary <- paste("star_result_binaries/", year, ".feather", sep = "")
    write_feather(cur, binary)
}
```

```{r}
# TEST STUFF FOR SOME YEAR
res1998 <- read_feather("star_result_binaries/1998.feather")
head(res1998)

res1999 <- read_feather("star_result_binaries/1999.feather")
head(res1999)
```
